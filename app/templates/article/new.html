{% extends "base.html" %}

{% block title %}New Article - PlanWrite{% endblock %}

{% block content %}
<div x-data="articleWizard()" class="max-w-4xl mx-auto space-y-6">

    <!-- Progress steps -->
    <nav aria-label="Progress">
        <ol class="flex items-center">
            <li class="relative pr-8 sm:pr-20" :class="step >= 1 ? 'text-primary-600' : 'text-gray-500'">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="h-0.5 w-full" :class="step > 1 ? 'bg-primary-600' : 'bg-gray-200'"></div>
                </div>
                <span class="relative flex h-8 w-8 items-center justify-center rounded-full"
                      :class="step >= 1 ? 'bg-primary-600 text-white' : 'bg-gray-200 text-gray-500'">
                    1
                </span>
                <span class="absolute -bottom-6 left-0 text-xs font-medium">Setup</span>
            </li>
            <li class="relative pr-8 sm:pr-20" :class="step >= 2 ? 'text-primary-600' : 'text-gray-500'">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="h-0.5 w-full" :class="step > 2 ? 'bg-primary-600' : 'bg-gray-200'"></div>
                </div>
                <span class="relative flex h-8 w-8 items-center justify-center rounded-full"
                      :class="step >= 2 ? 'bg-primary-600 text-white' : 'bg-gray-200 text-gray-500'">
                    2
                </span>
                <span class="absolute -bottom-6 left-0 text-xs font-medium">Outline</span>
            </li>
            <li class="relative pr-8 sm:pr-20" :class="step >= 3 ? 'text-primary-600' : 'text-gray-500'">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="h-0.5 w-full" :class="step > 3 ? 'bg-primary-600' : 'bg-gray-200'"></div>
                </div>
                <span class="relative flex h-8 w-8 items-center justify-center rounded-full"
                      :class="step >= 3 ? 'bg-primary-600 text-white' : 'bg-gray-200 text-gray-500'">
                    3
                </span>
                <span class="absolute -bottom-6 left-0 text-xs font-medium">Draft</span>
            </li>
            <li class="relative" :class="step >= 4 ? 'text-primary-600' : 'text-gray-500'">
                <span class="relative flex h-8 w-8 items-center justify-center rounded-full"
                      :class="step >= 4 ? 'bg-primary-600 text-white' : 'bg-gray-200 text-gray-500'">
                    4
                </span>
                <span class="absolute -bottom-6 left-0 text-xs font-medium">Export</span>
            </li>
        </ol>
    </nav>

    <div class="mt-12">
        <!-- Step 1: Setup -->
        <div x-show="step === 1" x-transition class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 space-y-6">
            <h2 class="text-lg font-semibold text-gray-900">Article Setup</h2>

            <form @submit.prevent="generateOutline" class="space-y-4">
                <!-- Offer selection -->
                <div>
                    <label for="offer_id" class="block text-sm font-medium text-gray-700">Select Offer</label>
                    <select x-model="form.offer_id" id="offer_id" name="offer_id"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        <option value="">-- No offer (generic article) --</option>
                        <template x-for="offer in offers" :key="offer.id">
                            <option :value="offer.id" x-text="offer.label"></option>
                        </template>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Leave empty for a generic article without promo</p>
                </div>

                <!-- State -->
                <div>
                    <label for="state" class="block text-sm font-medium text-gray-700">State</label>
                    <select x-model="form.state" id="state" name="state"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        <option value="ALL">All States</option>
                        <option value="NY">New York</option>
                        <option value="NJ">New Jersey</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="AZ">Arizona</option>
                        <option value="CO">Colorado</option>
                        <option value="OH">Ohio</option>
                        <option value="MI">Michigan</option>
                        <option value="VA">Virginia</option>
                        <option value="MA">Massachusetts</option>
                        <option value="KY">Kentucky</option>
                    </select>
                </div>

                <!-- Keyword -->
                <div>
                    <label for="keyword" class="block text-sm font-medium text-gray-700">Focus Keyword <span class="text-red-500">*</span></label>
                    <input type="text" x-model="form.keyword" id="keyword" name="keyword" required
                           placeholder="e.g., DraftKings promo code"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                </div>

                <!-- Title -->
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700">H1 Title <span class="text-red-500">*</span></label>
                    <input type="text" x-model="form.title" id="title" name="title" required
                           placeholder="e.g., DraftKings Promo Code: Get $150 Bonus Bets in January 2025"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                </div>

                <!-- Competitor URLs (optional) -->
                <div>
                    <label for="competitors" class="block text-sm font-medium text-gray-700">
                        Competitor URLs <span class="text-gray-400">(optional, one per line)</span>
                    </label>
                    <textarea x-model="form.competitors" id="competitors" name="competitors" rows="3"
                              placeholder="https://competitor1.com/article&#10;https://competitor2.com/article"
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"></textarea>
                </div>

                <div class="flex justify-end">
                    <button type="submit" :disabled="generating || !form.keyword || !form.title"
                            :class="generating ? 'opacity-50 cursor-not-allowed' : ''"
                            class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700">
                        <template x-if="generating">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </template>
                        <span x-text="generating ? 'Generating...' : 'Generate Outline'"></span>
                        <svg x-show="!generating" class="ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                        </svg>
                    </button>
                </div>
            </form>

            <!-- Status message -->
            <div x-show="statusMessage" x-transition class="mt-4 p-3 rounded-md" :class="statusType === 'error' ? 'bg-red-50 text-red-700' : 'bg-blue-50 text-blue-700'">
                <p x-text="statusMessage" class="text-sm"></p>
            </div>
        </div>

        <!-- Step 2: Outline -->
        <div x-show="step === 2" x-transition class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Article Outline</h2>
                <button type="button" @click="step = 1" class="text-sm text-gray-500 hover:text-gray-700">
                    &larr; Back to Setup
                </button>
            </div>

            <!-- Outline editor -->
            <div>
                <label for="outline" class="block text-sm font-medium text-gray-700 mb-2">
                    Edit outline tokens (one per line)
                </label>
                <textarea x-model="outline" id="outline" name="outline" rows="12"
                          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 font-mono text-sm"
                          placeholder="[INTRO]&#10;[SHORTCODE]&#10;[H2: Main Section]&#10;[H3: Subsection]"></textarea>
                <p class="mt-1 text-xs text-gray-500">
                    Tokens: [INTRO], [SHORTCODE], [H2: Title], [H3: Title]
                </p>
            </div>

            <div class="flex justify-between">
                <button type="button" @click="generateOutline" :disabled="generating"
                        class="inline-flex items-center rounded-md bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200">
                    <template x-if="generating">
                        <svg class="animate-spin mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </template>
                    <svg x-show="!generating" class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                    Regenerate Outline
                </button>

                <button type="button" @click="generateDraft" :disabled="generating || !outline.trim()"
                        :class="(generating || !outline.trim()) ? 'opacity-50 cursor-not-allowed' : ''"
                        class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700">
                    <template x-if="generating">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </template>
                    <span x-text="generating ? 'Generating...' : 'Generate Draft'"></span>
                    <svg x-show="!generating" class="ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                    </svg>
                </button>
            </div>

            <!-- Status message -->
            <div x-show="statusMessage" x-transition class="mt-4 p-3 rounded-md" :class="statusType === 'error' ? 'bg-red-50 text-red-700' : 'bg-blue-50 text-blue-700'">
                <p x-text="statusMessage" class="text-sm"></p>
            </div>
        </div>

        <!-- Step 3: Draft -->
        <div x-show="step === 3" x-transition class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Article Draft</h2>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500" x-show="wordCount > 0" x-text="wordCount + ' words'"></span>
                    <button type="button" @click="step = 2" class="text-sm text-gray-500 hover:text-gray-700">
                        &larr; Back to Outline
                    </button>
                </div>
            </div>

            <!-- Draft editor -->
            <div>
                <textarea x-model="draft" id="draft" name="draft" rows="20"
                          @input="wordCount = draft.split(/\s+/).filter(w => w).length"
                          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 font-mono text-sm"
                          placeholder="Draft content will appear here..."></textarea>
            </div>

            <!-- Compliance panel -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-gray-700">Compliance Check</h3>
                    <span x-show="complianceScore !== null"
                          :class="complianceScore >= 80 ? 'bg-green-100 text-green-800' : complianceScore >= 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'"
                          class="px-2 py-1 rounded text-xs font-medium"
                          x-text="'Score: ' + complianceScore"></span>
                </div>
                <div id="compliance-results" class="text-sm">
                    <template x-if="complianceIssues.length === 0 && complianceScore === null">
                        <p class="text-gray-500">Click "Validate" to check for compliance issues</p>
                    </template>
                    <template x-if="complianceIssues.length === 0 && complianceScore !== null">
                        <p class="text-green-600">No issues found!</p>
                    </template>
                    <template x-if="complianceIssues.length > 0">
                        <ul class="space-y-1">
                            <template x-for="issue in complianceIssues" :key="issue.message">
                                <li :class="issue.severity === 'error' ? 'text-red-600' : issue.severity === 'warning' ? 'text-yellow-600' : 'text-gray-600'">
                                    <span x-text="issue.severity === 'error' ? '✗' : issue.severity === 'warning' ? '⚠' : 'ℹ'"></span>
                                    <span x-text="issue.message"></span>
                                </li>
                            </template>
                        </ul>
                    </template>
                </div>
            </div>

            <div class="flex justify-between">
                <button type="button" @click="validateContent" :disabled="!draft.trim()"
                        class="inline-flex items-center rounded-md bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200">
                    Validate Content
                </button>

                <button type="button" @click="step = 4" :disabled="!draft.trim()"
                        class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700">
                    Continue to Export
                    <svg class="ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                    </svg>
                </button>
            </div>

            <!-- Status message -->
            <div x-show="statusMessage" x-transition class="mt-4 p-3 rounded-md" :class="statusType === 'error' ? 'bg-red-50 text-red-700' : 'bg-blue-50 text-blue-700'">
                <p x-text="statusMessage" class="text-sm"></p>
            </div>
        </div>

        <!-- Step 4: Export -->
        <div x-show="step === 4" x-transition class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Export Article</h2>
                <button type="button" @click="step = 3" class="text-sm text-gray-500 hover:text-gray-700">
                    &larr; Back to Draft
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Markdown -->
                <button type="button" @click="exportAs('md')"
                        class="flex flex-col items-center p-6 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-colors">
                    <svg class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                    </svg>
                    <span class="mt-2 font-medium text-gray-900">Markdown</span>
                    <span class="text-sm text-gray-500">.md</span>
                </button>

                <!-- HTML -->
                <button type="button" @click="exportAs('html')"
                        class="flex flex-col items-center p-6 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-colors">
                    <svg class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
                    </svg>
                    <span class="mt-2 font-medium text-gray-900">HTML</span>
                    <span class="text-sm text-gray-500">.html</span>
                </button>

                <!-- Copy to clipboard -->
                <button type="button" @click="copyToClipboard"
                        class="flex flex-col items-center p-6 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-colors">
                    <svg class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                    </svg>
                    <span class="mt-2 font-medium text-gray-900">Copy</span>
                    <span class="text-sm text-gray-500">Clipboard</span>
                </button>
            </div>

            <div class="flex justify-between pt-4 border-t">
                <button type="button" @click="saveArticle"
                        class="inline-flex items-center rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700">
                    <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Save Article
                </button>

                <a href="/"
                   class="inline-flex items-center rounded-md bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200">
                    Done
                </a>
            </div>

            <!-- Status message -->
            <div x-show="statusMessage" x-transition class="mt-4 p-3 rounded-md" :class="statusType === 'error' ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'">
                <p x-text="statusMessage" class="text-sm"></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function articleWizard() {
    return {
        step: 1,
        generating: false,
        statusMessage: '',
        statusType: 'info',

        // Form data
        form: {
            offer_id: '',
            state: 'ALL',
            keyword: '',
            title: '',
            competitors: ''
        },

        // Offers list
        offers: [],

        // Content
        outline: '',
        draft: '',
        wordCount: 0,

        // Compliance
        complianceScore: null,
        complianceIssues: [],

        // Initialize
        init() {
            this.loadOffers();
        },

        // Load offers from API
        async loadOffers() {
            try {
                const resp = await fetch('/api/offers/');
                if (resp.ok) {
                    const data = await resp.json();
                    this.offers = data.map(o => ({
                        id: o.id,
                        label: `${o.brand}: ${o.offer_text || o.affiliate_offer || 'Offer'}${o.bonus_code ? ` (code: ${o.bonus_code})` : ''}`
                    }));
                }
            } catch (e) {
                console.error('Failed to load offers:', e);
            }
        },

        // Generate outline
        async generateOutline() {
            if (!this.form.keyword || !this.form.title) {
                this.showStatus('Please fill in keyword and title', 'error');
                return;
            }

            this.generating = true;
            this.statusMessage = 'Connecting...';
            this.statusType = 'info';
            this.outline = '';

            const competitorUrls = this.form.competitors
                .split('\n')
                .map(u => u.trim())
                .filter(u => u.startsWith('http'));

            try {
                const resp = await fetch('/api/generate/outline/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyword: this.form.keyword,
                        title: this.form.title,
                        offer_id: this.form.offer_id || null,
                        state: this.form.state,
                        competitor_urls: competitorUrls.length > 0 ? competitorUrls : null
                    })
                });

                if (!resp.ok) throw new Error('Failed to generate outline');

                const data = await resp.json();
                this.outline = data.outline.join('\n');
                this.step = 2;
                this.showStatus('Outline generated!', 'info');
            } catch (e) {
                this.showStatus('Error: ' + e.message, 'error');
            } finally {
                this.generating = false;
            }
        },

        // Generate draft
        async generateDraft() {
            if (!this.outline.trim()) {
                this.showStatus('Please add an outline first', 'error');
                return;
            }

            this.generating = true;
            this.statusMessage = 'Generating draft... This may take a minute.';
            this.statusType = 'info';
            this.draft = '';

            const tokens = this.outline
                .split('\n')
                .map(t => t.trim())
                .filter(t => t.startsWith('['));

            try {
                const resp = await fetch('/api/generate/draft/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyword: this.form.keyword,
                        title: this.form.title,
                        outline_tokens: tokens,
                        offer_id: this.form.offer_id || null,
                        state: this.form.state
                    })
                });

                if (!resp.ok) throw new Error('Failed to generate draft');

                const data = await resp.json();
                this.draft = data.draft;
                this.wordCount = data.word_count || this.draft.split(/\s+/).filter(w => w).length;
                this.step = 3;
                this.showStatus('Draft generated!', 'info');
            } catch (e) {
                this.showStatus('Error: ' + e.message, 'error');
            } finally {
                this.generating = false;
            }
        },

        // Validate content
        async validateContent() {
            if (!this.draft.trim()) return;

            try {
                const resp = await fetch('/api/generate/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: this.draft,
                        state: this.form.state
                    })
                });

                if (!resp.ok) throw new Error('Validation failed');

                const data = await resp.json();
                this.complianceScore = Math.round(data.compliance_score);
                this.complianceIssues = data.issues || [];
                this.wordCount = data.word_count;
            } catch (e) {
                this.showStatus('Validation error: ' + e.message, 'error');
            }
        },

        // Export functions
        exportAs(format) {
            const filename = this.slugify(this.form.title) || 'article';

            if (format === 'md') {
                this.downloadFile(this.draft, `${filename}.md`, 'text/markdown');
            } else if (format === 'html') {
                const html = this.markdownToHtml(this.draft);
                const fullHtml = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>${this.form.title}</title>
<style>body{font-family:system-ui,sans-serif;max-width:800px;margin:0 auto;padding:2rem;line-height:1.6;}
h1{font-size:2rem;}h2{font-size:1.5rem;margin-top:2rem;}h3{font-size:1.25rem;}
blockquote{border-left:4px solid #ddd;margin:1rem 0;padding-left:1rem;color:#666;}</style>
</head><body>${html}</body></html>`;
                this.downloadFile(fullHtml, `${filename}.html`, 'text/html');
            }

            this.showStatus(`Exported as ${format.toUpperCase()}!`, 'info');
        },

        copyToClipboard() {
            navigator.clipboard.writeText(this.draft).then(() => {
                this.showStatus('Copied to clipboard!', 'info');
            }).catch(() => {
                this.showStatus('Failed to copy', 'error');
            });
        },

        // Save article to database
        async saveArticle() {
            try {
                const resp = await fetch('/api/articles/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: this.form.title,
                        keyword: this.form.keyword,
                        state: this.form.state,
                        offer_id: this.form.offer_id || null,
                        outline: this.outline,
                        draft: this.draft
                    })
                });

                if (!resp.ok) throw new Error('Failed to save');

                const data = await resp.json();
                this.showStatus(`Article saved! ID: ${data.id}`, 'info');
            } catch (e) {
                this.showStatus('Save error: ' + e.message, 'error');
            }
        },

        // Helpers
        showStatus(message, type = 'info') {
            this.statusMessage = message;
            this.statusType = type;
            if (type !== 'error') {
                setTimeout(() => { this.statusMessage = ''; }, 5000);
            }
        },

        slugify(text) {
            return (text || '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '')
                .substring(0, 50);
        },

        downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        },

        markdownToHtml(md) {
            // Simple markdown to HTML conversion
            return md
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^\> (.*$)/gm, '<blockquote>$1</blockquote>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.+)$/gm, '<p>$1</p>')
                .replace(/<p><h/g, '<h')
                .replace(/<\/h(\d)><\/p>/g, '</h$1>')
                .replace(/<p><blockquote>/g, '<blockquote>')
                .replace(/<\/blockquote><\/p>/g, '</blockquote>');
        }
    };
}
</script>
{% endblock %}
