{% extends "base.html" %}

{% block title %}New Draft - TopStoriesGenerator{% endblock %}

{% block content %}
<div x-data="articleWizard()" class="space-y-6">

    <!-- Mode tabs -->
    <div class="bw-panel p-2 flex flex-wrap gap-2">
        <button type="button" @click="activeTab = 'single'"
                class="px-4 py-2 text-sm font-medium rounded-md"
                :class="activeTab === 'single' ? 'bg-primary-600 text-white' : 'bg-white text-gray-600 border border-gray-200'">
            Single Draft
        </button>
        <button type="button" @click="activeTab = 'batch'"
                class="px-4 py-2 text-sm font-medium rounded-md"
                :class="activeTab === 'batch' ? 'bg-primary-600 text-white' : 'bg-white text-gray-600 border border-gray-200'">
            Batch Generator
        </button>
    </div>

    <!-- Progress steps -->
    <nav aria-label="Progress" class="bw-panel p-4" x-show="activeTab === 'single'" x-transition>
        <ol class="flex items-center">
            <li class="relative pr-8 sm:pr-20" :class="step >= 1 ? 'text-primary-600' : 'text-gray-500'">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="h-0.5 w-full" :class="step > 1 ? 'bg-primary-600' : 'bg-gray-200'"></div>
                </div>
                <span class="relative flex h-8 w-8 items-center justify-center rounded-full"
                      :class="step >= 1 ? 'bg-primary-600 text-white' : 'bg-gray-200 text-gray-500'">
                    1
                </span>
                <span class="absolute -bottom-6 left-0 text-xs font-medium">Setup</span>
            </li>
            <li class="relative pr-8 sm:pr-20" :class="step >= 2 ? 'text-primary-600' : 'text-gray-500'">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="h-0.5 w-full" :class="step > 2 ? 'bg-primary-600' : 'bg-gray-200'"></div>
                </div>
                <span class="relative flex h-8 w-8 items-center justify-center rounded-full"
                      :class="step >= 2 ? 'bg-primary-600 text-white' : 'bg-gray-200 text-gray-500'">
                    2
                </span>
                <span class="absolute -bottom-6 left-0 text-xs font-medium">Outline</span>
            </li>
            <li class="relative pr-8 sm:pr-20" :class="step >= 3 ? 'text-primary-600' : 'text-gray-500'">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="h-0.5 w-full" :class="step > 3 ? 'bg-primary-600' : 'bg-gray-200'"></div>
                </div>
                <span class="relative flex h-8 w-8 items-center justify-center rounded-full"
                      :class="step >= 3 ? 'bg-primary-600 text-white' : 'bg-gray-200 text-gray-500'">
                    3
                </span>
                <span class="absolute -bottom-6 left-0 text-xs font-medium">Draft</span>
            </li>
            <li class="relative" :class="step >= 4 ? 'text-primary-600' : 'text-gray-500'">
                <span class="relative flex h-8 w-8 items-center justify-center rounded-full"
                      :class="step >= 4 ? 'bg-primary-600 text-white' : 'bg-gray-200 text-gray-500'">
                    4
                </span>
                <span class="absolute -bottom-6 left-0 text-xs font-medium">Export</span>
            </li>
        </ol>
    </nav>

    <div class="mt-12">
        <!-- Step 1: Setup -->
        <div x-show="(activeTab === 'single' && step === 1) || activeTab === 'batch'" x-transition class="bw-panel p-6 space-y-6">
            <h2 class="text-lg font-semibold text-gray-900">Article Setup</h2>

            <form @submit.prevent="activeTab === 'single' ? generateOutline() : null" class="space-y-4">
                <!-- BAM property selector -->
                <div>
                    <label for="offer_property" class="block text-sm font-medium text-gray-700">Property</label>
                    <select x-model="form.offer_property" id="offer_property" name="offer_property"
                            @change="loadOffers()"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        <template x-for="prop in properties" :key="prop.key">
                            <option :value="prop.key" x-text="prop.label"></option>
                        </template>
                    </select>
                </div>

                <!-- Offer selection -->
                <div>
                    <label for="offer_id" class="block text-sm font-medium text-gray-700">Select Offer</label>
                    <select x-model="form.offer_id" id="offer_id" name="offer_id"
                            @change="updateAltOffers()"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        <option value="">-- No offer (generic article) --</option>
                        <template x-for="offer in offers" :key="offer.id">
                            <option :value="offer.id" x-text="offer.label"></option>
                        </template>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Leave empty for a generic article without promo</p>
                    <button type="button" @click="refreshOffers()"
                            class="mt-2 inline-flex items-center rounded-md bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        Refresh offers
                    </button>
                </div>

                <!-- Alternative offers -->
                <div x-show="form.offer_id && altOffers.length > 0" x-transition>
                    <label class="block text-sm font-medium text-gray-700">Alternative Offers (same brand)</label>
                    <p class="mt-1 text-xs text-gray-500">Select up to 2 additional promo cards to include</p>
                    <div class="mt-2 space-y-2">
                        <template x-for="alt in altOffers" :key="alt.id">
                            <label class="flex items-center space-x-2 text-sm text-gray-700">
                                <input type="checkbox"
                                       :checked="form.alt_offer_ids.includes(alt.id)"
                                       @change="toggleAltOffer(alt.id, $event.target.checked, $event)"
                                       class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                <span x-text="alt.label"></span>
                            </label>
                        </template>
                    </div>
                </div>

                <!-- State -->
                <div>
                    <label for="state" class="block text-sm font-medium text-gray-700">State</label>
                    <select x-model="form.state" id="state" name="state" @change="loadOffers()"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        <option value="ALL">All States</option>
                        <option value="NY">New York</option>
                        <option value="NJ">New Jersey</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="AZ">Arizona</option>
                        <option value="CO">Colorado</option>
                        <option value="OH">Ohio</option>
                        <option value="MI">Michigan</option>
                        <option value="VA">Virginia</option>
                        <option value="MA">Massachusetts</option>
                        <option value="KY">Kentucky</option>
                    </select>
                </div>

                <!-- Game Context Section -->
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <h3 class="text-sm font-medium text-gray-900 mb-3">Game Context (Optional)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Sport selector -->
                        <div>
                            <label for="sport" class="block text-sm font-medium text-gray-700">Sport</label>
                            <select x-model="form.sport" id="sport" name="sport" @change="loadGames()"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                <option value="">-- Select Sport --</option>
                                <template x-for="sport in sportsList" :key="sport.code">
                                    <option :value="sport.code" x-text="sport.label"></option>
                                </template>
                            </select>
                        </div>

                        <!-- Date picker -->
                        <div>
                            <label for="game_date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" x-model="form.game_date" id="game_date" name="game_date" @change="loadGames()"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        </div>

                        <!-- Game selector -->
                        <div>
                            <label for="game_id" class="block text-sm font-medium text-gray-700">Game</label>
                            <select x-model="form.game_id" id="game_id" name="game_id" @change="loadOdds()"
                                    :disabled="!form.sport || games.length === 0"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm disabled:bg-gray-100">
                                <option value="">-- Select Game --</option>
                                <template x-for="game in games" :key="game.id">
                                    <option :value="game.id" x-text="game.label"></option>
                                </template>
                            </select>
                            <p x-show="loadingGames" class="mt-1 text-xs text-gray-500">Loading games...</p>
                            <p x-show="!loadingGames && form.sport && games.length === 0" class="mt-1 text-xs text-yellow-600">No games found for this date</p>
                        </div>
                    </div>

                      <!-- Odds Display Panel -->
                      <div x-show="selectedGame && odds" x-transition class="mt-4 bw-card p-4">
                          <div class="flex items-center justify-between mb-3">
                              <h4 class="text-sm font-medium text-gray-900" x-text="selectedGame ? selectedGame.headline : ''"></h4>
                              <span class="text-xs text-gray-500" x-text="selectedGame ? selectedGame.time_display : ''"></span>
                          </div>

                          <div class="mb-3">
                              <label class="block text-xs text-gray-500">Book</label>
                              <select x-model="selectedBook"
                                      class="mt-1 block w-full rounded-md border-gray-300 bg-white shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                  <template x-for="book in availableBooks" :key="book">
                                      <option :value="book" x-text="book"></option>
                                  </template>
                              </select>
                          </div>

                          <!-- Odds grid (selected book only) -->
                          <div class="grid grid-cols-4 gap-2 text-xs" x-show="availableBooks.length">
                              <div class="font-medium text-gray-500">Book</div>
                              <div class="font-medium text-gray-500">Spread</div>
                              <div class="font-medium text-gray-500">ML</div>
                              <div class="font-medium text-gray-500">Total</div>

                              <div class="contents" x-show="selectedBook">
                                  <div class="font-medium text-gray-700" x-text="selectedBook"></div>
                                  <div class="text-gray-600">
                                      <span x-text="odds.spreads && odds.spreads[selectedBook]?.away_line || '-'"></span>
                                      <span class="text-gray-400" x-text="odds.spreads && odds.spreads[selectedBook]?.away_odds ? `(${odds.spreads[selectedBook].away_odds})` : ''"></span>
                                  </div>
                                  <div class="text-gray-600">
                                      <span x-text="odds.moneylines && odds.moneylines[selectedBook]?.away_odds || '-'"></span>
                                  </div>
                                  <div class="text-gray-600">
                                      <span x-text="odds.totals && odds.totals[selectedBook]?.total || '-'"></span>
                                  </div>
                              </div>
                          </div>

                          <p x-show="!availableBooks.length" class="text-sm text-gray-500">No odds available for this game</p>

                        <!-- Bet Example Builder -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <h4 class="text-sm font-medium text-gray-900 mb-2">Bet Example Builder</h4>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-500">Bet Amount</label>
                                    <input type="number" x-model="betBuilder.amount" min="1" max="1000"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
                                           placeholder="100">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500">Bet Type</label>
                                    <select x-model="betBuilder.type"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                        <option value="spread">Spread</option>
                                        <option value="moneyline">Moneyline</option>
                                        <option value="total">Total</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500">Team</label>
                                    <select x-model="betBuilder.team"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                        <option value="away" x-text="selectedGame?.away_team || 'Away'"></option>
                                        <option value="home" x-text="selectedGame?.home_team || 'Home'"></option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button type="button" @click="generateBetExample()"
                                        class="text-xs text-primary-600 hover:text-primary-800 font-medium">
                                    Generate bet example text &rarr;
                                </button>
                            </div>
                            <div x-show="betExample" x-transition class="mt-2 p-2 bw-card text-sm text-gray-700">
                                <p x-text="betExample"></p>
                                <button type="button" @click="copyBetExample()" class="mt-1 text-xs text-primary-600 hover:underline">Copy</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Keyword / Title / Competitors (single draft only) -->
                <div x-show="activeTab === 'single'" x-transition class="space-y-4">
                    <div>
                        <label for="keyword" class="block text-sm font-medium text-gray-700">Focus Keyword <span class="text-red-500">*</span></label>
                        <input type="text" x-model="form.keyword" id="keyword" name="keyword" :required="activeTab === 'single'"
                               placeholder="e.g., DraftKings promo code"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                    </div>

                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700">H1 Title <span class="text-red-500">*</span></label>
                        <input type="text" x-model="form.title" id="title" name="title" :required="activeTab === 'single'"
                               placeholder="e.g., DraftKings Promo Code: Get $150 Bonus Bets in January 2025"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                    </div>

                    <div>
                        <label for="competitors" class="block text-sm font-medium text-gray-700">
                            Competitor URLs <span class="text-gray-400">(optional, one per line)</span>
                        </label>
                        <textarea x-model="form.competitors" id="competitors" name="competitors" rows="3"
                                  placeholder="https://competitor1.com/article&#10;https://competitor2.com/article"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"></textarea>
                    </div>
                </div>

                <div class="flex justify-end" x-show="activeTab === 'single'">
                    <button type="submit" :disabled="generating || !form.keyword || !form.title"
                            :class="generating ? 'opacity-50 cursor-not-allowed' : ''"
                            class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700">
                        <template x-if="generating">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </template>
                        <span x-text="generating ? 'Generating...' : 'Generate Outline'"></span>
                        <svg x-show="!generating" class="ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                        </svg>
                    </button>
                </div>
                <div x-show="activeTab === 'batch'" class="text-xs text-gray-500">
                    Setup applies to every queued item.
                </div>
            </form>

            <!-- Status message -->
            <div x-show="statusMessage" x-transition class="mt-4 p-3 rounded-md" :class="statusType === 'error' ? 'bg-red-50 text-red-700' : 'bg-blue-50 text-blue-700'">
                <p x-text="statusMessage" class="text-sm"></p>
            </div>
        </div>

        <!-- Batch Generator Tab -->
        <div x-show="activeTab === 'batch'" x-transition class="bw-panel p-6 space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Batch Generator</h2>
                    <p class="text-xs text-gray-500">Uses the setup context above for all queued drafts.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Keyword</label>
                    <input type="text" x-model="batch.newItem.keyword"
                           placeholder="e.g., bet365 promo code"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                </div>
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" x-model="batch.newItem.title"
                           placeholder="e.g., bet365 Promo Code: Get $200 Bonus Bets"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-3">
                <button type="button" @click="addToQueue()"
                        class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700">
                    Add to Queue
                </button>
                <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-500">Mode</label>
                    <select x-model="batch.mode"
                            class="rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-xs">
                        <option value="draft">Drafts</option>
                        <option value="outline">Outlines</option>
                    </select>
                </div>
            </div>

            <div class="space-y-3" x-show="batch.queue.length > 0">
                <template x-for="item in batch.queue" :key="item.id">
                    <div class="bw-card p-4 space-y-2">
                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <div class="text-sm font-semibold text-gray-900" x-text="item.title"></div>
                                <div class="text-xs text-gray-500" x-text="item.keyword"></div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-gray-500" x-text="item.status"></span>
                                <button type="button" @click="removeFromQueue(item.id)"
                                        class="text-xs text-gray-500 hover:text-red-600">
                                    Remove
                                </button>
                            </div>
                        </div>
                        <template x-if="item.error">
                            <p class="text-xs text-red-600" x-text="item.error"></p>
                        </template>
                        <template x-if="item.output">
                            <div class="space-y-2">
                                <textarea readonly rows="6"
                                          class="w-full rounded-md border border-gray-200 bg-white p-2 text-xs text-gray-700"
                                          x-text="item.output"></textarea>
                                <button type="button" @click="copyBatchOutput(item.output)"
                                        class="text-xs text-primary-600 hover:underline">
                                    Copy output
                                </button>
                            </div>
                        </template>
                    </div>
                </template>
            </div>

            <p x-show="batch.queue.length === 0" class="text-xs text-gray-500">No items in the queue yet.</p>

            <div class="flex flex-wrap gap-3">
                <button type="button" @click="runBatchQueue()" :disabled="batch.running || batch.queue.length === 0"
                        :class="(batch.running || batch.queue.length === 0) ? 'opacity-50 cursor-not-allowed' : ''"
                        class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700">
                    Batch Generate
                </button>
                <button type="button" @click="clearBatch()"
                        class="inline-flex items-center rounded-md bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    Clear Queue
                </button>
                <span x-show="batch.running" class="text-xs text-primary-600" x-text="batch.progress"></span>
            </div>
        </div>

        <!-- Step 2: Outline -->
        <div x-show="activeTab === 'single' && step === 2" x-transition class="bw-panel p-6 space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Article Outline</h2>
                <button type="button" @click="step = 1" class="text-sm text-gray-500 hover:text-gray-700">
                    &larr; Back to Setup
                </button>
            </div>

            <!-- Outline editor -->
            <div>
                <label for="outline" class="block text-sm font-medium text-gray-700 mb-2">
                    Edit outline plan (sections + talking points)
                </label>
                <textarea x-model="outline" id="outline" name="outline" rows="12"
                          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 font-mono text-sm"
                          placeholder="[INTRO]&#10;> Hook with date and offer value&#10;&#10;[SHORTCODE]&#10;&#10;[H2: Offer Overview]&#10;> Why this offer is useful&#10;! Avoid: Repeating intro"></textarea>
                <p class="mt-1 text-xs text-gray-500">
                    Supported format: section headers plus optional `>` talking points and `! Avoid:` directives.
                </p>
            </div>

            <div class="flex justify-between">
                <button type="button" @click="generateOutline" :disabled="generating"
                        class="inline-flex items-center rounded-md bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200">
                    <template x-if="generating">
                        <svg class="animate-spin mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </template>
                    <svg x-show="!generating" class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                    Regenerate Outline
                </button>

                <button type="button" @click="generateDraft" :disabled="generating || !outline.trim()"
                        :class="(generating || !outline.trim()) ? 'opacity-50 cursor-not-allowed' : ''"
                        class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700">
                    <template x-if="generating">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </template>
                    <span x-text="generating ? 'Generating...' : 'Generate Draft'"></span>
                    <svg x-show="!generating" class="ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                    </svg>
                </button>
            </div>

            <!-- Status message -->
            <div x-show="statusMessage" x-transition class="mt-4 p-3 rounded-md" :class="statusType === 'error' ? 'bg-red-50 text-red-700' : 'bg-blue-50 text-blue-700'">
                <p x-text="statusMessage" class="text-sm"></p>
            </div>
        </div>

        <!-- Step 3: Draft -->
        <div x-show="activeTab === 'single' && step === 3" x-transition class="bw-panel p-6 space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Article Draft</h2>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500" x-show="wordCount > 0" x-text="wordCount + ' words'"></span>
                    <div class="inline-flex rounded-md shadow-sm" role="group">
                        <button type="button"
                                @click="previewMode = false"
                                :class="previewMode ? 'bg-white text-gray-700' : 'bg-primary-600 text-white'"
                                class="px-3 py-1.5 text-xs font-medium border border-gray-300 rounded-l-md hover:bg-gray-50">
                            Edit
                        </button>
                        <button type="button"
                                @click="previewMode = true"
                                :class="previewMode ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'"
                                class="px-3 py-1.5 text-xs font-medium border border-gray-300 border-l-0 rounded-r-md hover:bg-gray-50">
                            Preview
                        </button>
                    </div>
                    <button type="button" @click="step = 2" class="text-sm text-gray-500 hover:text-gray-700">
                        &larr; Back to Outline
                    </button>
                </div>
            </div>

            <!-- Draft editor -->
            <div x-show="!previewMode">
                <textarea x-model="draft" id="draft" name="draft" rows="20"
                          @input="wordCount = draft.split(/\s+/).filter(w => w).length"
                          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 font-mono text-sm"
                          placeholder="Draft content will appear here..."></textarea>
            </div>
            <div x-show="previewMode" x-transition
                 class="prose-article max-w-none rounded-md border border-gray-200 bg-gray-50 p-4">
                <div x-html="previewHtml || '<p class=&quot;text-gray-500&quot;>No draft to preview yet.</p>'"></div>
            </div>

            <!-- Compliance panel -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-3">
                        <h3 class="text-sm font-medium text-gray-700">Compliance Check</h3>
                        <div class="flex items-center space-x-2 text-xs" x-show="complianceScore !== null">
                            <span class="px-2 py-0.5 rounded bg-red-100 text-red-700">
                                Errors: <span x-text="errorCount"></span>
                            </span>
                            <span class="px-2 py-0.5 rounded bg-yellow-100 text-yellow-700">
                                Warnings: <span x-text="warningCount"></span>
                            </span>
                            <span class="px-2 py-0.5 rounded bg-blue-100 text-blue-700">
                                Info: <span x-text="infoCount"></span>
                            </span>
                        </div>
                    </div>
                    <span x-show="complianceScore !== null"
                          :class="complianceScore >= 80 ? 'bg-green-100 text-green-800' : complianceScore >= 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'"
                          class="px-2 py-1 rounded text-xs font-medium"
                          x-text="'Score: ' + complianceScore"></span>
                </div>
                <div id="compliance-results" class="text-sm">
                    <template x-if="complianceIssues.length === 0 && complianceScore === null">
                        <p class="text-gray-500">Click "Validate" to check for compliance issues</p>
                    </template>
                    <template x-if="complianceIssues.length === 0 && complianceScore !== null">
                        <p class="text-green-600">No issues found!</p>
                    </template>
                    <template x-if="complianceIssues.length > 0">
                        <ul class="space-y-2">
                            <template x-for="issue in complianceIssues" :key="issue.message">
                                <li class="rounded-md border border-gray-200 bg-white p-2">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span class="px-2 py-0.5 rounded text-xs font-medium"
                                                  :class="severityBadgeClass(issue.severity)"
                                                  x-text="severityLabel(issue.severity)"></span>
                                            <span class="text-gray-900" x-text="issue.message"></span>
                                        </div>
                                        <span class="text-[10px] uppercase tracking-wide text-gray-400"
                                              x-text="issue.type || 'notice'"></span>
                                    </div>
                                    <template x-if="issue.suggestion">
                                        <p class="mt-1 text-xs text-gray-500" x-text="'Suggestion: ' + issue.suggestion"></p>
                                    </template>
                                    <template x-if="issue.location">
                                        <p class="text-[11px] text-gray-400" x-text="'Location: ' + issue.location"></p>
                                    </template>
                                </li>
                            </template>
                        </ul>
                    </template>
                </div>
            </div>

            <div class="flex justify-between">
                <button type="button" @click="validateContent" :disabled="!draft.trim()"
                        class="inline-flex items-center rounded-md bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200">
                    Validate Content
                </button>

                <button type="button" @click="step = 4" :disabled="!draft.trim()"
                        class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700">
                    Continue to Export
                    <svg class="ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                    </svg>
                </button>
            </div>

            <!-- Status message -->
            <div x-show="statusMessage" x-transition class="mt-4 p-3 rounded-md" :class="statusType === 'error' ? 'bg-red-50 text-red-700' : 'bg-blue-50 text-blue-700'">
                <p x-text="statusMessage" class="text-sm"></p>
            </div>
        </div>

        <!-- Step 4: Export -->
        <div x-show="activeTab === 'single' && step === 4" x-transition class="bw-panel p-6 space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Export Article</h2>
                <button type="button" @click="step = 3" class="text-sm text-gray-500 hover:text-gray-700">
                    &larr; Back to Draft
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Markdown -->
                <button type="button" @click="exportAs('md')"
                        class="flex flex-col items-center p-6 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-colors">
                    <svg class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                    </svg>
                    <span class="mt-2 font-medium text-gray-900">Markdown</span>
                    <span class="text-sm text-gray-500">.md</span>
                </button>

                <!-- HTML -->
                <button type="button" @click="exportAs('html')"
                        class="flex flex-col items-center p-6 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-colors">
                    <svg class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
                    </svg>
                    <span class="mt-2 font-medium text-gray-900">HTML</span>
                    <span class="text-sm text-gray-500">.html</span>
                </button>

                <!-- Copy to clipboard -->
                <button type="button" @click="copyToClipboard"
                        class="flex flex-col items-center p-6 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-colors">
                    <svg class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                    </svg>
                    <span class="mt-2 font-medium text-gray-900">Copy</span>
                    <span class="text-sm text-gray-500">Clipboard</span>
                </button>
            </div>

            <div class="flex justify-between pt-4 border-t">
                <button type="button" @click="saveArticle"
                        class="inline-flex items-center rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700">
                    <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Save Article
                </button>

                <a href="/"
                   class="inline-flex items-center rounded-md bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200">
                    Done
                </a>
            </div>

            <!-- Status message -->
            <div x-show="statusMessage" x-transition class="mt-4 p-3 rounded-md" :class="statusType === 'error' ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'">
                <p x-text="statusMessage" class="text-sm"></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function articleWizard() {
    return {
        activeTab: 'single',
        step: 1,
        generating: false,
        statusMessage: '',
        statusType: 'info',

        // Form data
        form: {
            offer_property: 'action_network',
            offer_id: '',
            alt_offer_ids: [],
            state: 'ALL',
            keyword: '',
            title: '',
            competitors: '',
            sport: '',
            game_date: new Date().toISOString().split('T')[0],
            game_id: ''
        },

        // Offers list
        properties: [],
        offersRaw: [],
        offers: [],
        altOffers: [],

        // Sports and games
        sportsList: [
            { code: 'nfl', label: 'NFL' },
            { code: 'nba', label: 'NBA' },
            { code: 'mlb', label: 'MLB' },
            { code: 'nhl', label: 'NHL' },
            { code: 'ncaaf', label: 'CFB' },
            { code: 'ncaab', label: 'CBB' }
        ],
        games: [],
        loadingGames: false,
          selectedGame: null,
          odds: null,
          selectedBook: '',

        // Bet builder
        betBuilder: {
            amount: 100,
            type: 'spread',
            team: 'away'
        },
        betExample: '',

        // Batch generation
        batch: {
            mode: 'draft',
            newItem: { keyword: '', title: '' },
            queue: [],
            running: false,
            progress: ''
        },

          // Content
          outline: '',
          outlineStructured: null,
          draft: '',
          wordCount: 0,
          previewMode: false,

        // Compliance
        complianceScore: null,
        complianceIssues: [],

        get errorCount() {
            return this.complianceIssues.filter(i => i.severity === 'error').length;
        },
        get warningCount() {
            return this.complianceIssues.filter(i => i.severity === 'warning').length;
        },
        get infoCount() {
            return this.complianceIssues.filter(i => i.severity === 'info').length;
        },
          get previewHtml() {
              if (!this.draft) return '';
              const hasHtml = /<\w+[^>]*>/.test(this.draft);
              return hasHtml ? this.draft : this.markdownToHtml(this.draft);
          },
          get availableBooks() {
              if (!this.odds) return [];
              const books = new Set();
              const spreads = this.odds.spreads || {};
              const moneylines = this.odds.moneylines || {};
              const totals = this.odds.totals || {};
              Object.keys(spreads).forEach(b => books.add(b));
              Object.keys(moneylines).forEach(b => books.add(b));
              Object.keys(totals).forEach(b => books.add(b));
              (this.odds.available_sportsbooks || []).forEach(b => books.add(b));
              return Array.from(books);
          },
        severityLabel(severity) {
            if (severity === 'error') return 'Error';
            if (severity === 'warning') return 'Warning';
            return 'Info';
        },
        severityBadgeClass(severity) {
            if (severity === 'error') return 'bg-red-100 text-red-700';
            if (severity === 'warning') return 'bg-yellow-100 text-yellow-700';
            return 'bg-blue-100 text-blue-700';
        },

        // Initialize
        init() {
            console.log('ArticleWizard init called');
            this.loadProperties();
            this.loadOffers();
        },

        async loadProperties() {
            try {
                const resp = await fetch('/api/offers/properties/list');
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.properties) {
                        this.properties = Object.entries(data.properties).map(([key, label]) => ({ key, label }));
                        if (!this.form.offer_property && this.properties.length > 0) {
                            this.form.offer_property = this.properties[0].key;
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to load properties:', e);
            }
        },

        // Load offers from API
        async loadOffers() {
            console.log('Loading offers...');
            try {
                const params = new URLSearchParams();
                if (this.form.offer_property) params.set('property', this.form.offer_property);
                if (this.form.state) params.set('state', this.form.state);

                const resp = await fetch(`/api/offers/?${params}`);
                console.log('Offers response status:', resp.status);
                if (resp.ok) {
                    let data = await resp.json();
                    // Filter out casino-only offers
                    data = data.filter(o => {
                        const text = `${o.offer_text || ''} ${o.affiliate_offer || ''}`.toLowerCase();
                        return !text.includes('casino') && !text.includes('slots') && !text.includes('poker');
                    });
                    this.offersRaw = data;
                    console.log('Offers loaded:', data.length);
                    this.offers = data.map(o => ({
                        id: o.id || o.offer_id,
                        brand: o.brand,
                        label: `${o.brand}: ${o.offer_text || o.affiliate_offer || 'Offer'}${o.bonus_code ? ` (code: ${o.bonus_code})` : ''}`
                    }));
                    // Ensure current selection is still valid
                    if (this.form.offer_id && !this.offersRaw.find(o => (o.id || o.offer_id) === this.form.offer_id)) {
                        this.form.offer_id = '';
                        this.form.alt_offer_ids = [];
                    }
                    this.updateAltOffers();
                    console.log('Offers mapped:', this.offers.length);
                } else {
                    console.error('Offers response not ok:', resp.status);
                }
            } catch (e) {
                console.error('Failed to load offers:', e);
            }
        },

        updateAltOffers() {
            this.altOffers = [];
            if (!this.form.offer_id) {
                this.form.alt_offer_ids = [];
                return;
            }
            const main = this.offersRaw.find(o => (o.id || o.offer_id) === this.form.offer_id);
            if (!main || !main.brand) return;
            this.altOffers = this.offersRaw
                .filter(o => o.brand === main.brand && (o.id || o.offer_id) !== this.form.offer_id)
                .map(o => ({
                    id: o.id || o.offer_id,
                    label: `${o.bonus_code ? o.bonus_code + ': ' : ''}${(o.offer_text || o.affiliate_offer || 'Offer').slice(0, 70)}`
                }));
            this.form.alt_offer_ids = [];
        },

        toggleAltOffer(id, checked, evt) {
            if (checked) {
                if (this.form.alt_offer_ids.length >= 2) {
                    if (evt && evt.target) evt.target.checked = false;
                    this.showStatus('You can select up to 2 alternative offers', 'error');
                    return;
                }
                this.form.alt_offer_ids.push(id);
            } else {
                this.form.alt_offer_ids = this.form.alt_offer_ids.filter(x => x !== id);
            }
        },

        async refreshOffers() {
            try {
                const params = new URLSearchParams();
                if (this.form.offer_property) params.set('property', this.form.offer_property);
                await fetch(`/api/offers/sync?${params}`, { method: 'POST' });
                this.loadOffers();
                this.showStatus('Offers refreshed', 'info');
            } catch (e) {
                this.showStatus('Failed to refresh offers', 'error');
            }
        },

        // Load games for selected sport and date
        async loadGames() {
            if (!this.form.sport) {
                this.games = [];
                this.selectedGame = null;
                this.odds = null;
                return;
            }

              this.loadingGames = true;
              this.games = [];
              this.form.game_id = '';
              this.selectedGame = null;
              this.odds = null;
              this.selectedBook = '';

            try {
                const params = new URLSearchParams({
                    sport: this.form.sport,
                    date: this.form.game_date
                });
                const resp = await fetch(`/api/events/games?${params}`);
                if (resp.ok) {
                    const data = await resp.json();
                    this.games = data.map(g => ({
                        id: g.id,
                        label: `${g.away_team} @ ${g.home_team} - ${this.formatGameTime(g.start_time)}`,
                        ...g
                    }));
                }
            } catch (e) {
                console.error('Failed to load games:', e);
            } finally {
                this.loadingGames = false;
            }
        },

        // Load odds for selected game
        async loadOdds() {
            if (!this.form.game_id || !this.form.sport) {
                this.selectedGame = null;
                this.odds = null;
                return;
            }

            // Find selected game data
            this.selectedGame = this.games.find(g => g.id === this.form.game_id);
            if (!this.selectedGame) return;

            // Add display info
            this.selectedGame.headline = `${this.selectedGame.away_team} @ ${this.selectedGame.home_team}`;
            this.selectedGame.time_display = this.formatGameTime(this.selectedGame.start_time);

                try {
                    const awayParam = [this.selectedGame.away_abbrev, this.selectedGame.away_team]
                        .filter(Boolean)
                        .join(' ');
                    const homeParam = [this.selectedGame.home_abbrev, this.selectedGame.home_team]
                        .filter(Boolean)
                        .join(' ');
                    const params = new URLSearchParams({
                        sport: this.form.sport,
                        away_team: awayParam,
                        home_team: homeParam,
                        game_date: this.form.game_date
                    });
                  if (this.selectedGame.week_id) {
                      params.set('week', this.selectedGame.week_id);
                  }
                  const resp = await fetch(`/api/odds/game?${params}`);
                  if (resp.ok) {
                      this.odds = await resp.json();
                      const books = this.availableBooks;
                      if (!this.selectedBook || !books.includes(this.selectedBook)) {
                          this.selectedBook = books[0] || '';
                      }
                  } else {
                      this.odds = null;
                      this.selectedBook = '';
                  }
              } catch (e) {
                  console.error('Failed to load odds:', e);
                  this.odds = null;
                  this.selectedBook = '';
              }
          },

        // Generate bet example text
        async generateBetExample() {
            if (!this.selectedGame || !this.odds) {
                this.betExample = '';
                return;
            }

            try {
                  const resp = await fetch('/api/odds/bet-example', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                          game: {
                              away_team: this.selectedGame.away_team,
                              home_team: this.selectedGame.home_team
                          },
                          odds: this.odds,
                          bet_amount: parseInt(this.betBuilder.amount) || 100,
                          bet_type: this.betBuilder.type,
                          team: this.betBuilder.team,
                          sportsbook: this.selectedBook || 'draftkings'
                      })
                  });
                if (resp.ok) {
                    const data = await resp.json();
                    this.betExample = data.example_text;
                }
            } catch (e) {
                console.error('Failed to generate bet example:', e);
            }
        },

        copyBetExample() {
            if (this.betExample) {
                navigator.clipboard.writeText(this.betExample);
                this.showStatus('Bet example copied', 'info');
            }
        },

        // Batch helpers
        buildBatchGameContext() {
            if (!this.selectedGame) return null;
            const gameContext = {
                sport: this.form.sport,
                away_team: this.selectedGame.away_team,
                home_team: this.selectedGame.home_team,
                start_time: this.selectedGame.start_time,
                network: this.selectedGame.network,
                headline: this.selectedGame.headline
            };
            if (this.odds) gameContext.odds = this.odds;
            if (this.betExample) gameContext.bet_example = this.betExample;
            return gameContext;
        },

        async fetchBatchOutline(item, gameContext) {
            const competitorUrls = this.form.competitors
                .split('\n')
                .map(u => u.trim())
                .filter(u => u.startsWith('http'));
            const resp = await fetch('/api/generate/outline/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    keyword: item.keyword,
                    title: item.title,
                    offer_id: this.form.offer_id || null,
                    offer_property: this.form.offer_property || null,
                    alt_offer_ids: this.form.alt_offer_ids || [],
                    state: this.form.state,
                    competitor_urls: competitorUrls.length > 0 ? competitorUrls : null,
                    game_context: gameContext
                })
            });
            if (!resp.ok) throw new Error('Outline failed');
            const data = await resp.json();
            return {
                tokens: data.outline || [],
                text: data.outline_text || (data.outline || []).join('\n'),
                structured: data.outline_structured || null
            };
        },

        async fetchBatchDraft(item, outlineData, gameContext) {
            const resp = await fetch('/api/generate/draft/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    keyword: item.keyword,
                    title: item.title,
                    outline_tokens: outlineData.tokens,
                    outline_text: outlineData.text,
                    outline_structured: outlineData.structured,
                    offer_id: this.form.offer_id || null,
                    offer_property: this.form.offer_property || null,
                    alt_offer_ids: this.form.alt_offer_ids || [],
                    state: this.form.state,
                    game_context: gameContext
                })
            });
            if (!resp.ok) throw new Error('Draft failed');
            const data = await resp.json();
            return data.draft || '';
        },

        addToQueue() {
            const keyword = (this.batch.newItem.keyword || '').trim();
            const title = (this.batch.newItem.title || '').trim();
            if (!keyword || !title) {
                this.showStatus('Add both keyword and title', 'error');
                return;
            }
            this.batch.queue.push({
                id: Date.now() + Math.random(),
                keyword,
                title,
                status: 'queued',
                error: '',
                output: ''
            });
            this.batch.newItem.keyword = '';
            this.batch.newItem.title = '';
        },

        removeFromQueue(id) {
            this.batch.queue = this.batch.queue.filter(item => item.id !== id);
        },

        async runBatchQueue() {
            if (this.batch.running) return;
            if (!this.batch.queue.length) {
                this.showStatus('Add at least one item to the queue', 'error');
                return;
            }

            this.batch.running = true;
            this.batch.progress = `Processing 0/${this.batch.queue.length}`;
            const gameContext = this.buildBatchGameContext();

            for (let i = 0; i < this.batch.queue.length; i++) {
                const item = this.batch.queue[i];
                this.batch.progress = `Processing ${i + 1}/${this.batch.queue.length}`;
                item.error = '';
                try {
                    item.status = 'Generating outline';
                    const outlineData = await this.fetchBatchOutline(item, gameContext);
                    if (!outlineData.tokens.length && !outlineData.text.trim()) {
                        item.status = 'error';
                        item.error = 'Outline empty';
                        continue;
                    }

                    if (this.batch.mode === 'outline') {
                        item.output = outlineData.text;
                        item.status = 'done';
                        continue;
                    }

                    item.status = 'Generating draft';
                    const draft = await this.fetchBatchDraft(item, outlineData, gameContext);
                    item.output = draft || '';
                    item.status = draft ? 'done' : 'error';
                    if (!draft) item.error = 'Draft empty';
                } catch (e) {
                    item.status = 'error';
                    item.error = e.message || 'Failed';
                }
            }

            this.batch.running = false;
            this.batch.progress = 'Done';
        },

        clearBatch() {
            this.batch.queue = [];
            this.batch.newItem.keyword = '';
            this.batch.newItem.title = '';
            this.batch.progress = '';
            this.batch.running = false;
        },

        copyBatchOutput(text) {
            if (!text) return;
            navigator.clipboard.writeText(text);
            this.showStatus('Batch output copied', 'info');
        },

        formatGameTime(isoString) {
            if (!isoString) return '';
            try {
                const dt = new Date(isoString);
                return dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', timeZoneName: 'short' });
            } catch (e) {
                return '';
            }
        },

        // Generate outline
        async generateOutline() {
            if (!this.form.keyword || !this.form.title) {
                this.showStatus('Please fill in keyword and title', 'error');
                return;
            }

            this.generating = true;
            this.statusMessage = 'Connecting...';
            this.statusType = 'info';
            this.outline = '';

            const competitorUrls = this.form.competitors
                .split('\n')
                .map(u => u.trim())
                .filter(u => u.startsWith('http'));

            // Build game context if selected
            let gameContext = null;
            if (this.selectedGame) {
                gameContext = {
                    sport: this.form.sport,
                    away_team: this.selectedGame.away_team,
                    home_team: this.selectedGame.home_team,
                    start_time: this.selectedGame.start_time,
                    network: this.selectedGame.network,
                    headline: this.selectedGame.headline
                };
                if (this.odds) {
                    gameContext.odds = this.odds;
                }
                if (this.betExample) {
                    gameContext.bet_example = this.betExample;
                }
            }

            try {
                const resp = await fetch('/api/generate/outline/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyword: this.form.keyword,
                        title: this.form.title,
                        offer_id: this.form.offer_id || null,
                        offer_property: this.form.offer_property || null,
                        alt_offer_ids: this.form.alt_offer_ids || [],
                        state: this.form.state,
                        competitor_urls: competitorUrls.length > 0 ? competitorUrls : null,
                        game_context: gameContext
                    })
                });

                if (!resp.ok) throw new Error('Failed to generate outline');

                const data = await resp.json();
                this.outline = data.outline_text || (data.outline || []).join('\n');
                this.outlineStructured = data.outline_structured || null;
                this.step = 2;
                this.showStatus('Outline generated!', 'info');
            } catch (e) {
                this.showStatus('Error: ' + e.message, 'error');
            } finally {
                this.generating = false;
            }
        },

        // Generate draft
        async generateDraft() {
            if (!this.outline.trim()) {
                this.showStatus('Please add an outline first', 'error');
                return;
            }

            this.generating = true;
            this.statusMessage = 'Generating draft... This may take a minute.';
            this.statusType = 'info';
            this.draft = '';

            const tokens = this.outline
                .split('\n')
                .map(t => t.trim())
                .filter(t => t.startsWith('['));

            // Build game context if selected
            let gameContext = null;
            if (this.selectedGame) {
                gameContext = {
                    sport: this.form.sport,
                    away_team: this.selectedGame.away_team,
                    home_team: this.selectedGame.home_team,
                    start_time: this.selectedGame.start_time,
                    network: this.selectedGame.network,
                    headline: this.selectedGame.headline
                };
                if (this.odds) {
                    gameContext.odds = this.odds;
                }
                if (this.betExample) {
                    gameContext.bet_example = this.betExample;
                }
            }

            try {
                const resp = await fetch('/api/generate/draft/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyword: this.form.keyword,
                        title: this.form.title,
                        outline_tokens: tokens,
                        outline_text: this.outline,
                        outline_structured: this.outlineStructured,
                        offer_id: this.form.offer_id || null,
                        offer_property: this.form.offer_property || null,
                        alt_offer_ids: this.form.alt_offer_ids || [],
                        state: this.form.state,
                        game_context: gameContext
                    })
                });

                if (!resp.ok) throw new Error('Failed to generate draft');

                const data = await resp.json();
                this.draft = data.draft;
                this.wordCount = data.word_count || this.draft.split(/\s+/).filter(w => w).length;
                this.step = 3;
                this.showStatus('Draft generated!', 'info');
            } catch (e) {
                this.showStatus('Error: ' + e.message, 'error');
            } finally {
                this.generating = false;
            }
        },

        // Validate content
        async validateContent() {
            if (!this.draft.trim()) return;

            try {
                const resp = await fetch('/api/generate/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: this.draft,
                        state: this.form.state,
                        keyword: this.form.keyword,
                        offer_id: this.form.offer_id,
                        offer_property: this.form.offer_property
                    })
                });

                if (!resp.ok) throw new Error('Validation failed');

                const data = await resp.json();
                this.complianceScore = Math.round(data.compliance_score);
                const severityOrder = { error: 0, warning: 1, info: 2 };
                this.complianceIssues = (data.issues || []).sort((a, b) => {
                    return (severityOrder[a.severity] ?? 9) - (severityOrder[b.severity] ?? 9);
                });
                this.wordCount = data.word_count;
            } catch (e) {
                this.showStatus('Validation error: ' + e.message, 'error');
            }
        },

        // Export functions
        exportAs(format) {
            const filename = this.slugify(this.form.title) || 'article';

            if (format === 'md') {
                this.downloadFile(this.draft, `${filename}.md`, 'text/markdown');
            } else if (format === 'html') {
                const html = this.markdownToHtml(this.draft);
                const fullHtml = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>${this.form.title}</title>
<style>body{font-family:system-ui,sans-serif;max-width:800px;margin:0 auto;padding:2rem;line-height:1.6;}
h1{font-size:2rem;}h2{font-size:1.5rem;margin-top:2rem;}h3{font-size:1.25rem;}
blockquote{border-left:4px solid #ddd;margin:1rem 0;padding-left:1rem;color:#666;}</style>
</head><body>${html}</body></html>`;
                this.downloadFile(fullHtml, `${filename}.html`, 'text/html');
            }

            this.showStatus(`Exported as ${format.toUpperCase()}!`, 'info');
        },

        copyToClipboard() {
            navigator.clipboard.writeText(this.draft).then(() => {
                this.showStatus('Copied to clipboard!', 'info');
            }).catch(() => {
                this.showStatus('Failed to copy', 'error');
            });
        },

        // Save article to database
        async saveArticle() {
            try {
                const resp = await fetch('/api/articles/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: this.form.title,
                        keyword: this.form.keyword,
                        state: this.form.state,
                        offer_id: this.form.offer_id || null,
                        offer_property: this.form.offer_property || null,
                        outline: this.outline,
                        draft: this.draft
                    })
                });

                if (!resp.ok) throw new Error('Failed to save');

                const data = await resp.json();
                this.showStatus(`Article saved! ID: ${data.id}`, 'info');
            } catch (e) {
                this.showStatus('Save error: ' + e.message, 'error');
            }
        },

        // Helpers
        showStatus(message, type = 'info') {
            this.statusMessage = message;
            this.statusType = type;
            if (type !== 'error') {
                setTimeout(() => { this.statusMessage = ''; }, 5000);
            }
        },

        slugify(text) {
            return (text || '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '')
                .substring(0, 50);
        },

        downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        },

        markdownToHtml(md) {
            // Simple markdown to HTML conversion
            return md
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^\> (.*$)/gm, '<blockquote>$1</blockquote>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.+)$/gm, '<p>$1</p>')
                .replace(/<p><h/g, '<h')
                .replace(/<\/h(\d)><\/p>/g, '</h$1>')
                .replace(/<p><blockquote>/g, '<blockquote>')
                .replace(/<\/blockquote><\/p>/g, '</blockquote>');
        }
    };
}
</script>
{% endblock %}
